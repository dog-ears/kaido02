[README](../README.md) / 認証機能 テストケース

# 認証機能 テストケース

Supabase Auth による Email/Password 認証機能の確認すべきテストケース一覧です。

## E2E 自動化方針（2025-11-16 時点）

### 分類の定義

- `E2E自動化対象`: Playwright で自動テストを実装し、ローカルの Supabase テスト環境に対して毎回実行する。
- `手動確認`: ブラウザ固有挙動・外部サービス・複雑な前提などに依存し、自動化コストに対して効果が低いため手動カバレッジに留める。
- `将来検討`: 今回はスコープ外だが、UI 改修やリファクタ後に自動化できる余地がある。
- `対象外（未実装）`: 現行アプリに該当機能が存在しないため、テスト自体を保留する。

### ケース別ステータス

| テストID | シナリオ | 分類 | 理由/備考 |
| --- | --- | --- | --- |
| TC-001 | 正常な新規登録 | E2E自動化対象 | クリティカルフロー。登録成功と `/login?registered=true` リダイレクトを Playwright で検証する。 |
| TC-002 | パスワード不一致エラー | E2E自動化対象 | クライアントバリデーションのロジックを保持するため UI 経由で検証する。 |
| TC-003 | パスワード長不足エラー | E2E自動化対象 | HTML5 の `minLength` によるバリデーションが発火して送信が拒否されることを確認する。 |
| TC-004 | 既存メールアドレス登録エラー | E2E自動化対象 | Supabase が既存メールでも再登録を受け付ける挙動であるため、ログインページへリダイレクトされることを確認する。 |
| TC-005 | 無効なメール形式 | 手動確認 | HTML5 仕様に依存するため主要ブラウザでのスポット確認で十分。 |
| TC-006 | 必須項目未入力 | 手動確認 | ブラウザ標準バリデーションのため自動化のメリットが小さい。 |
| TC-007 | 登録中のローディング | 将来検討 | UI 表示のみのため後続で余裕があれば Playwright 断面テストを追加する。 |
| TC-008 | 正常なログイン | E2E自動化対象 | 認証成立と `/` リダイレクト、ログイン中表示を確認する。 |
| TC-009 | 間違ったパスワード | E2E自動化対象 | エラー表示と遷移抑止を継続的に担保する。 |
| TC-010 | 未登録メールアドレス | E2E自動化対象 | 期待されるエラーメッセージをシードに依存せず検証できる。 |
| TC-011 | 保護ページからのリダイレクト後ログイン | 対象外（未実装） | `/dashboard` 等の保護ページやミドルウェアが未導入。 |
| TC-012 | ログイン中ローディング | 将来検討 | UI 状態のみ。主要フローの自動化完了後に追加予定。 |
| TC-013 | ログイン→新規登録リンク | 手動確認 | 単純なナビゲーションでリグレッションリスクが小さい。 |
| TC-014 | 正常なログアウト | E2E自動化対象 | サインアウト処理と UI の状態遷移を担保する。 |
| TC-015 | ログアウト中ローディング | 将来検討 | UI 表示のみ。優先度を下げ後続対応。 |
| TC-016 | メール確認リンク | 手動確認 | メール配信と実アドレス操作が必要なため手動でのスポット確認に留める。 |
| TC-017 | メール未確認でのログイン | 手動確認 | Supabase 設定に依存し、本番テナントでのみ評価すべき事項。 |
| TC-018 | 未認証ユーザーの保護ページアクセス | 対象外（未実装） | 保護対象ページとリダイレクトロジックがまだ存在しない。 |
| TC-019 | 未認証ユーザーによる /profile アクセス | 対象外（未実装） | 上記と同様。 |
| TC-020 | 認証済みユーザーが保護ページにアクセス | 対象外（未実装） | 専用ページがないためテスト不能。 |
| TC-021 | 認証済みユーザーが公開ページにアクセス | 手動確認 | リダイレクト要件がなく、デザイン変更時に目視で十分。 |
| TC-022 | ページリロード後のセッション維持 | E2E自動化対象 | Playwright の `page.reload()` で cookie 維持を検証する。 |
| TC-023 | 別タブでのセッション共有 | 手動確認 | ブラウザ間通信検証が複雑なため手動リグレッションとする。 |
| TC-024 | ログアウト後の別タブ状態 | 手動確認 | 上記と同理由で自動化コストが高い。 |
| TC-025 | 環境変数未設定時の動作 | 手動確認 | 環境ブートストラップのケースで、E2E とは別の設定テストで扱う。 |
| TC-026 | ネットワークエラー | 手動確認 | ネットワーク切断を自動で再現するコストに見合わない。 |
| TC-027 | レスポンシブデザイン | 手動確認 | デザインQAとしてビューポート複数確認を手動で実施。 |
| TC-028 | ダークモード対応 | 手動確認 | 視覚的検証が中心なためスナップショットテストの検討に留める。 |
| TC-029 | アクセシビリティ | 手動確認 | 専用ツール（axe など）による監査を別途実施。 |
| TC-030 | ローカル環境での動作 | 手動確認 | `npm run dev` 手動確認で十分、E2E は局所シナリオを担保。 |
| TC-031 | 本番環境での動作 | 手動確認 | デプロイ後の本番 Smoke テストとして扱う。 |
| TC-032 | プレビュー環境での動作 | 手動確認 | PR ごとに Vercel プレビューで人間が確認する。 |
| TC-033 | XSS 対策 | 手動確認 | フォーム入力のサニタイズは別途セキュリティテストで実施。 |
| TC-034 | CSRF 対策 | 手動確認 | Supabase 側の保護機能確認であり E2E では担保しない。 |
| TC-035 | パスワードの平文送信確認 | 手動確認 | HTTPS 環境でのネットワーク解析が必要なためリリース前チェックで対応。 |

> 今後、保護ページや追加 UI が実装された場合は「対象外」項目を再評価し、E2E スコープを拡張する。

### データリセット手順

- Playwright の `globalSetup` で `npm run seed:auth` を自動実行し、Supabase 認証ユーザーを毎回既定のシードデータに戻す。
- 必要に応じて `SKIP_E2E_SEED=true` を環境変数で指定すると、既存データを保持したままテストを実行できる。
- 手動でシードを流したい場合は、リポジトリルートで `npm run seed:auth` を実行する。

## 1. ユーザー登録機能

### TC-001: 正常な新規登録

**前提条件**: 未登録のメールアドレスを使用

**手順**:

1. `/register`にアクセス
2. 有効なメールアドレスを入力
3. パスワードを入力（6 文字以上）
4. 確認用パスワードに同じパスワードを入力
5. 登録ボタンをクリック

**期待結果**:

- 登録が成功する
- `/login?registered=true`にリダイレクトされる
- メール確認メールが送信される（Supabase 設定による）

---

### TC-002: パスワード不一致エラー

**前提条件**: なし

**手順**:

1. `/register`にアクセス
2. 有効なメールアドレスを入力
3. パスワードを入力
4. 確認用パスワードに異なるパスワードを入力
5. 登録ボタンをクリック

**期待結果**:

- エラーメッセージ「パスワードが一致しません」が表示される
- 登録が実行されない
- ページ遷移しない

---

### TC-003: パスワード長不足エラー

**前提条件**: なし

**手順**:

1. `/register`にアクセス
2. 有効なメールアドレスを入力
3. 5 文字以下のパスワードを入力
4. 確認用パスワードに同じパスワードを入力
5. 登録ボタンをクリック

**期待結果**:

- エラーメッセージ「パスワードは 6 文字以上である必要があります」が表示される
- 登録が実行されない
- ページ遷移しない

---

### TC-004: 既存メールアドレスでの登録エラー

**前提条件**: 既に登録済みのメールアドレスを使用

**手順**:

1. `/register`にアクセス
2. 既に登録済みのメールアドレスを入力
3. パスワードを入力（6 文字以上）
4. 確認用パスワードに同じパスワードを入力
5. 登録ボタンをクリック

**期待結果**:

- Supabase のエラーメッセージが表示される（例: "User already registered"）
- 登録が実行されない
- ページ遷移しない

---

### TC-005: 無効なメールアドレス形式エラー

**前提条件**: なし

**手順**:

1. `/register`にアクセス
2. 無効なメールアドレス形式を入力（例: "test@", "test", "@example.com"）
3. パスワードを入力（6 文字以上）
4. 確認用パスワードに同じパスワードを入力
5. 登録ボタンをクリック

**期待結果**:

- HTML5 のバリデーションエラーが表示される（ブラウザによる）
- または Supabase のエラーメッセージが表示される
- 登録が実行されない

---

### TC-006: 必須項目未入力エラー

**前提条件**: なし

**手順**:

1. `/register`にアクセス
2. メールアドレス、パスワード、確認用パスワードのいずれかを空欄のまま
3. 登録ボタンをクリック

**期待結果**:

- HTML5 のバリデーションエラーが表示される
- 登録が実行されない

---

### TC-007: 登録中のローディング状態

**前提条件**: なし

**手順**:

1. `/register`にアクセス
2. 有効な情報を入力
3. 登録ボタンをクリック

**期待結果**:

- 登録ボタンが「登録中...」と表示され、無効化される
- 登録処理中は再度クリックできない

---

## 2. ログイン機能

### TC-008: 正常なログイン

**前提条件**: 登録済みかつメール確認済みのアカウントを使用

**手順**:

1. `/login`にアクセス
2. 登録済みのメールアドレスを入力
3. 正しいパスワードを入力
4. ログインボタンをクリック

**期待結果**:

- ログインが成功する
- ホームページ（`/`）にリダイレクトされる
- ホームページに「ログイン中: [メールアドレス]」と表示される
- ログアウトボタンが表示される

---

### TC-009: 間違ったパスワードでのログインエラー

**前提条件**: 登録済みのアカウントを使用

**手順**:

1. `/login`にアクセス
2. 登録済みのメールアドレスを入力
3. 間違ったパスワードを入力
4. ログインボタンをクリック

**期待結果**:

- エラーメッセージが表示される（例: "Invalid login credentials"）
- ログインが実行されない
- ページ遷移しない

---

### TC-010: 存在しないメールアドレスでのログインエラー

**前提条件**: なし

**手順**:

1. `/login`にアクセス
2. 未登録のメールアドレスを入力
3. 任意のパスワードを入力
4. ログインボタンをクリック

**期待結果**:

- エラーメッセージが表示される（例: "Invalid login credentials"）
- ログインが実行されない
- ページ遷移しない

---

### TC-011: 保護されたページからのリダイレクト後のログイン

**前提条件**: 未ログイン状態

**手順**:

1. `/dashboard`または`/profile`に直接アクセス
2. `/login?redirectedFrom=/dashboard`（または`/profile`）にリダイレクトされることを確認
3. 正しい認証情報を入力してログイン

**期待結果**:

- ログインが成功する
- 元のページ（`/dashboard`または`/profile`）にリダイレクトされる
- ホームページではなく、リダイレクト元のページが表示される

---

### TC-012: ログイン中のローディング状態

**前提条件**: なし

**手順**:

1. `/login`にアクセス
2. 認証情報を入力
3. ログインボタンをクリック

**期待結果**:

- ログインボタンが「ログイン中...」と表示され、無効化される
- ログイン処理中は再度クリックできない

---

### TC-013: ログインページから新規登録ページへのリンク

**前提条件**: なし

**手順**:

1. `/login`にアクセス
2. 「新規登録」リンクをクリック

**期待結果**:

- `/register`に遷移する

---

## 3. ログアウト機能

### TC-014: 正常なログアウト

**前提条件**: ログイン済み状態

**手順**:

1. ホームページ（`/`）にアクセス
2. ログアウトボタンをクリック

**期待結果**:

- ログアウトが成功する
- ホームページ（`/`）にリダイレクトされる
- 「ログインしていません」と表示される
- ログインボタンと新規登録ボタンが表示される
- ログアウトボタンが表示されない

---

### TC-015: ログアウト中のローディング状態

**前提条件**: ログイン済み状態

**手順**:

1. ホームページ（`/`）にアクセス
2. ログアウトボタンをクリック

**期待結果**:

- ログアウトボタンが「ログアウト中...」と表示され、無効化される
- ログアウト処理中は再度クリックできない

---

## 4. メール確認機能

### TC-016: メール確認リンクのクリック

**前提条件**: 新規登録後、メール確認メールが送信されている

**手順**:

1. 新規登録時に送信されたメール確認メールを開く
2. メール内の確認リンクをクリック

**期待結果**:

- 正しいリダイレクト URL（本番環境: `https://kaido02.vercel.app/**`、ローカル: `http://localhost:3000/**`）にリダイレクトされる
- メール確認が完了する
- ログイン可能な状態になる

---

### TC-017: メール未確認状態でのログイン

**前提条件**: 新規登録後、メール確認が未完了

**手順**:

1. `/login`にアクセス
2. メール未確認のアカウントでログインを試みる

**期待結果**:

- Supabase の設定により、エラーメッセージが表示される可能性がある
- または、ログインは成功するが、メール確認が必要である旨のメッセージが表示される
- （Supabase の設定により動作が異なる）

---

## 5. 認証保護機能（ミドルウェア）

### TC-018: 未認証ユーザーが保護されたページにアクセス

**前提条件**: 未ログイン状態

**手順**:

1. `/dashboard`に直接アクセス

**期待結果**:

- `/login?redirectedFrom=/dashboard`にリダイレクトされる
- ログインページが表示される

---

### TC-019: 未認証ユーザーが保護されたページにアクセス（/profile）

**前提条件**: 未ログイン状態

**手順**:

1. `/profile`に直接アクセス

**期待結果**:

- `/login?redirectedFrom=/profile`にリダイレクトされる
- ログインページが表示される

---

### TC-020: 認証済みユーザーが保護されたページにアクセス

**前提条件**: ログイン済み状態

**手順**:

1. `/dashboard`または`/profile`に直接アクセス

**期待結果**:

- リダイレクトされない
- ページが正常に表示される（ページが存在する場合）

---

### TC-021: 認証済みユーザーが公開ページにアクセス

**前提条件**: ログイン済み状態

**手順**:

1. `/`、`/login`、`/register`にアクセス

**期待結果**:

- リダイレクトされない
- ページが正常に表示される

---

## 6. セッション管理

### TC-022: ページリロード後のセッション維持

**前提条件**: ログイン済み状態

**手順**:

1. ホームページ（`/`）にアクセス
2. ブラウザのリロードボタンをクリック

**期待結果**:

- ログイン状態が維持される
- 「ログイン中: [メールアドレス]」と表示される
- ログアウトボタンが表示される

---

### TC-023: 別タブでのセッション共有

**前提条件**: ログイン済み状態

**手順**:

1. ブラウザでログイン済みのタブを開く
2. 新しいタブで同じサイトにアクセス

**期待結果**:

- 新しいタブでもログイン状態が反映される
- 「ログイン中: [メールアドレス]」と表示される

---

### TC-024: ログアウト後の別タブでの状態

**前提条件**: 複数のタブでログイン済み状態

**手順**:

1. タブ A でログアウト
2. タブ B をリロード

**期待結果**:

- タブ B でもログアウト状態になる
- 「ログインしていません」と表示される

---

## 7. エラーハンドリング

### TC-025: 環境変数未設定時の動作

**前提条件**: 環境変数`NEXT_PUBLIC_SUPABASE_URL`または`NEXT_PUBLIC_SUPABASE_ANON_KEY`が未設定

**手順**:

1. 環境変数を削除または無効化
2. アプリケーションを起動
3. ログインまたは登録を試みる

**期待結果**:

- クライアントサイド: エラーメッセージが表示される
- サーバーサイド: エラーログが出力される
- ミドルウェア: 環境変数が未設定の場合は、そのまま通過させる（保護されない）

---

### TC-026: ネットワークエラー時の動作

**前提条件**: ネットワーク接続を切断

**手順**:

1. ネットワーク接続を切断
2. ログインまたは登録を試みる

**期待結果**:

- エラーメッセージが表示される
- 適切なエラーハンドリングが行われる

---

## 8. UI/UX

### TC-027: レスポンシブデザイン

**前提条件**: なし

**手順**:

1. ログインページ、登録ページを様々な画面サイズで表示
2. モバイル、タブレット、デスクトップで確認

**期待結果**:

- すべての画面サイズで適切に表示される
- フォームが使いやすい

---

### TC-028: ダークモード対応

**前提条件**: ブラウザまたは OS でダークモードを有効化

**手順**:

1. ダークモードでログインページ、登録ページ、ホームページを表示

**期待結果**:

- ダークモードで適切に表示される
- テキストが読みやすい

---

### TC-029: アクセシビリティ

**前提条件**: なし

**手順**:

1. キーボードのみで操作
2. スクリーンリーダーで操作

**期待結果**:

- すべての機能がキーボードで操作可能
- 適切なラベルが設定されている
- フォーカス管理が適切

---

## 9. 環境・設定

### TC-030: ローカル環境での動作

**前提条件**: ローカル環境で`npm run dev`を実行

**手順**:

1. ローカル環境でアプリケーションを起動
2. 登録、ログイン、ログアウトを実行

**期待結果**:

- すべての機能が正常に動作する
- ローカル用の Supabase プロジェクトに接続される

---

### TC-031: 本番環境（Vercel）での動作

**前提条件**: Vercel にデプロイ済み

**手順**:

1. 本番環境の URL にアクセス
2. 登録、ログイン、ログアウトを実行

**期待結果**:

- すべての機能が正常に動作する
- 本番用の Supabase プロジェクトに接続される
- ビルドエラーが発生しない

---

### TC-032: プレビュー環境（Vercel）での動作

**前提条件**: プルリクエストが作成され、Vercel プレビューがデプロイされている

**手順**:

1. プレビュー環境の URL にアクセス
2. 登録、ログイン、ログアウトを実行

**期待結果**:

- すべての機能が正常に動作する
- 環境変数が正しく設定されている

---

## 10. セキュリティ

### TC-033: XSS 対策

**前提条件**: なし

**手順**:

1. メールアドレスやパスワードフィールドにスクリプトタグを入力
2. 登録またはログインを試みる

**期待結果**:

- スクリプトが実行されない
- 適切にエスケープされる

---

### TC-034: CSRF 対策

**前提条件**: なし

**手順**:

1. 外部サイトからフォームを送信しようとする

**期待結果**:

- Supabase が適切に CSRF 対策を実施している
- 不正なリクエストが拒否される

---

### TC-035: パスワードの平文送信確認

**前提条件**: なし

**手順**:

1. 開発者ツールのネットワークタブを開く
2. ログインまたは登録を実行

**期待結果**:

- パスワードは HTTPS で暗号化されて送信される
- （本番環境では必ず HTTPS を使用）

---

## テスト実行時の注意事項

1. **テストデータの管理**: テスト用のメールアドレスとパスワードを用意し、テスト後に削除する
2. **環境の確認**: ローカル環境と本番環境でそれぞれテストを実行する
3. **Supabase 設定の確認**: メール確認の必須/任意設定、リダイレクト URL 設定を確認する
4. **ブラウザの確認**: 主要なブラウザ（Chrome, Firefox, Safari, Edge）でテストする
5. **エラーログの確認**: ブラウザのコンソールとサーバーログを確認する
